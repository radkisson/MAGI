version: '3.8'

services:
  # --- THE CORTEX (Brain) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: rin-cortex
    restart: always
    ports:
      - "${PORT_WEBUI:-3000}:8080"
    volumes:
      - ./data/open-webui:/app/backend/data
      # Mount the tools directly so they are available immediately
      - ./tools:/app/backend/data/tools
    environment:
      - OPENAI_API_BASE_URL=http://litellm:4000
      - ENABLE_RAG_WEB_SEARCH=True
      - SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>
    env_file: .env
    depends_on:
      - litellm
      - qdrant
      - searxng
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- THE ROUTER ---
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: rin-router
    restart: always
    ports:
      - "4000:4000"
    volumes:
      - ./config/litellm/config.yaml:/app/config.yaml
    command: [ "--config", "/app/config.yaml", "--port", "4000" ]
    env_file: .env

  # --- THE SENSORIUM (Vision) ---
  searxng:
    image: searxng/searxng:latest
    container_name: rin-vision
    restart: always
    ports:
      - "8080:8080"
    volumes:
      - ./config/searxng:/etc/searxng
    env_file: .env
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # --- THE DIGESTION ---
  firecrawl:
    image: mendableai/firecrawl:latest
    container_name: rin-digestion
    restart: always
    ports:
      - "3002:3002"
    environment:
      - REDIS_URL=redis://redis:6379
      - PLAYWRIGHT_MICROSERVICE_URL=http://playwright:3000
      # Automatically uses the key generated in start.sh
      - TEST_API_KEY=${FIRECRAWL_API_KEY} 
    depends_on:
      - redis
      - playwright

  playwright:
    image: mcr.microsoft.com/playwright:v1.43.0-jammy
    container_name: rin-browser
    command: npx -y playwright run-server --port 3000
    restart: always

  # --- SUPPORT ---
  redis:
    image: redis:alpine
    container_name: rin-reflex
    restart: always
    volumes:
      - ./data/redis:/data

  qdrant:
    image: qdrant/qdrant
    container_name: rin-memory
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
