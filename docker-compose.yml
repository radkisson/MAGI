services:
  # --- THE CORTEX (Brain) ---
  open-webui:
    # Note: Using 'main' tag for latest features as specified in deployment architecture
    image: ghcr.io/open-webui/open-webui:main
    container_name: magi-cortex
    restart: always
    ports:
      - "${PORT_WEBUI:-3000}:8080"
    volumes:
      - ./data/open-webui:/app/backend/data
      # Mount the tools directly so they are available immediately
      - ./tools:/app/backend/data/tools
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/app/ssl:ro
    environment:
      - OPENAI_API_BASE_URL=http://litellm:4000
      - ENABLE_RAG_WEB_SEARCH=True
      - SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>
      # External Senses: API Keys for Tools (Auto-Configuration)
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/app/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/app/ssl/key.pem}
    env_file: .env
    depends_on:
      litellm:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      searxng:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- THE ROUTER ---
  litellm:
    # Note: Using 'main-latest' tag for latest features as specified in deployment architecture
    image: ghcr.io/berriai/litellm:main-latest
    container_name: magi-router
    restart: always
    ports:
      - "${PORT_LITELLM:-4000}:4000"
    volumes:
      - ./config/litellm/config.yaml:/app/config.yaml
      - ./data/litellm:/app/data
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/app/ssl:ro
    command: [ "--config", "/app/config.yaml", "--port", "4000" ]
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Set defaults for OpenRouter webhook headers to prevent NoneType errors
      # These provide fallback defaults when not set in .env or the host environment
      - OPENROUTER_SITE_URL=${OPENROUTER_SITE_URL:-http://localhost:3000}
      - OPENROUTER_APP_NAME=${OPENROUTER_APP_NAME:-MAGI - Multi-Agent General Intelligence}
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/app/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/app/ssl/key.pem}
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:4000/')\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- THE SENSORIUM (Vision) ---
  searxng:
    # Note: Requires config/searxng/settings.yml to be created before starting
    # Run ./start.sh to auto-generate configuration, or manually create from settings.yml.example
    image: searxng/searxng:latest
    container_name: magi-vision
    restart: always
    ports:
      - "${PORT_SEARXNG:-8080}:8080"
    volumes:
      - ./config/searxng:/etc/searxng
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/etc/ssl/rin:ro
    env_file: .env
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/etc/ssl/rin/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/etc/ssl/rin/key.pem}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- THE DIGESTION ---
  firecrawl:
    image: ghcr.io/firecrawl/firecrawl:latest
    container_name: magi-digestion
    restart: always
    profiles:
      - firecrawl
    ports:
      - "${PORT_FIRECRAWL:-3002}:3002"
    volumes:
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/app/ssl:ro
    environment:
      - REDIS_URL=redis://redis:6379
      - PLAYWRIGHT_MICROSERVICE_URL=http://playwright-service:3000/scrape
      # Automatically uses the key generated in start.sh
      - TEST_API_KEY=${FIRECRAWL_API_KEY}
      - HOST=0.0.0.0
      - PORT=3002
      - USE_DB_AUTHENTICATION=false
      - NUM_WORKERS_PER_QUEUE=1
      # Disable NUQ database and RabbitMQ setup (prevents Docker-in-Docker errors)
      # These are non-functional placeholder values that prevent automatic container setup
      # Do NOT use these values for actual database connections
      - NUQ_DATABASE_URL=postgresql://disabled:disabled@127.0.0.1:1/disabled
      - NUQ_RABBITMQ_URL=amqp://disabled:disabled@127.0.0.1:1
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/app/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/app/ssl/key.pem}
    depends_on:
      - redis
      - playwright-service

  playwright-service:
    image: ghcr.io/firecrawl/playwright-service:latest
    container_name: magi-browser
    restart: always
    profiles:
      - firecrawl
    environment:
      - PORT=3000

  # --- THE REFLEX (Autonomy) ---
  n8n:
    image: hank033/n8n-python:latest
    container_name: magi-reflex-automation
    restart: always
    ports:
      - "${PORT_N8N:-5678}:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workflows:/workflows:ro
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/ssl:ro
      # Mount custom entrypoint for HTTPS configuration
      - ./scripts/docker-entrypoints/n8n-entrypoint.sh:/custom-entrypoint.sh:ro
    entrypoint: ["/custom-entrypoint.sh"]
    command: ["n8n"]
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - GENERIC_TIMEZONE=UTC
      # HTTPS Configuration for n8n (processed by entrypoint)
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - N8N_SSL_KEY=${SSL_KEY_PATH:-/ssl/key.pem}
      - N8N_SSL_CERT=${SSL_CERT_PATH:-/ssl/cert.pem}
    env_file: .env
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- THE MCP BRIDGE (Sequential Thinking) ---
  mcp-bridge:
    image: ghcr.io/open-webui/mcpo:main
    container_name: magi-mcp-bridge
    restart: always
    ports:
      - "${PORT_MCP_BRIDGE:-9000}:${PORT_MCP_BRIDGE:-9000}"
    volumes:
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/ssl:ro
    environment:
      - PORT_MCP_BRIDGE=${PORT_MCP_BRIDGE:-9000}
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/ssl/key.pem}
    command:
      - "--port"
      - "${PORT_MCP_BRIDGE:-9000}"
      - "--"
      - "npx"
      - "-y"
      - "@modelcontextprotocol/server-sequential-thinking"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${PORT_MCP_BRIDGE:-9000}/openapi.json || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # This service bridges Model Context Protocol (MCP) tools to Open WebUI.
    # Sequential Thinking forces the AI to use a "Chain of Thought" approach,
    # resulting in deeper, more methodical reasoning for complex queries.

  # --- YOUTUBE TRANSCRIPT BRIDGE ---
  youtube-mcp:
    image: ghcr.io/open-webui/mcpo:main
    container_name: magi-youtube-mcp
    restart: always
    ports:
      - "${PORT_YOUTUBE_MCP:-9001}:${PORT_YOUTUBE_MCP:-9001}"
    volumes:
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/ssl:ro
    environment:
      - PORT_YOUTUBE_MCP=${PORT_YOUTUBE_MCP:-9001}
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/ssl/key.pem}
    command:
      - "--port"
      - "${PORT_YOUTUBE_MCP:-9001}"
      - "--"
      - "npx"
      - "-y"
      - "@sinco-lab/mcp-youtube-transcript"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${PORT_YOUTUBE_MCP:-9001}/openapi.json || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # This service allows the AI to "watch" videos by reading YouTube subtitle tracks.
    # Uses the mcpo image which includes Node.js, npm, and mcpo pre-installed.

  # --- JUPYTER NOTEBOOK (Code Execution & Analysis) ---
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: magi-jupyter
    restart: always
    ports:
      - "${PORT_JUPYTER:-8888}:8888"
    volumes:
      - ./data/jupyter/notebooks:/home/jovyan/work
      - ./config/ssl:/home/jovyan/ssl:ro
      # Mount requirements for custom package installation
      - ./requirements.txt:/home/jovyan/requirements.txt:ro
    environment:
      - JUPYTER_ENABLE_LAB=yes
      # OpenRouter integration via environment variables
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LITELLM_BASE_URL=http://litellm:4000
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      # Jupyter authentication token (set to empty for no auth, or provide a token)
      # For production, set JUPYTER_TOKEN in .env to a secure random string
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-}
      # Grant sudo access to install packages (can be disabled for production)
      - GRANT_SUDO=yes
    user: root
    command: >
      bash -c "
      if [ ! -f /home/jovyan/.jupyter/jupyter_lab_config.py ]; then
        mkdir -p /home/jovyan/.jupyter &&
        echo \"c.ServerApp.ip = '0.0.0.0'\" > /home/jovyan/.jupyter/jupyter_lab_config.py &&
        echo \"c.ServerApp.allow_origin = '*'\" >> /home/jovyan/.jupyter/jupyter_lab_config.py &&
        if [ -n \"$$JUPYTER_TOKEN\" ]; then
          echo \"c.ServerApp.token = '$$JUPYTER_TOKEN'\" >> /home/jovyan/.jupyter/jupyter_lab_config.py;
        else
          echo \"c.ServerApp.token = ''\" >> /home/jovyan/.jupyter/jupyter_lab_config.py &&
          echo \"c.ServerApp.password = ''\" >> /home/jovyan/.jupyter/jupyter_lab_config.py;
        fi &&
        if [ \"$$ENABLE_HTTPS\" = \"true\" ]; then
          echo \"c.ServerApp.certfile = '/home/jovyan/ssl/cert.pem'\" >> /home/jovyan/.jupyter/jupyter_lab_config.py &&
          echo \"c.ServerApp.keyfile = '/home/jovyan/ssl/key.pem'\" >> /home/jovyan/.jupyter/jupyter_lab_config.py;
        fi &&
        chown -R jovyan:users /home/jovyan/.jupyter;
      fi &&
      pip install --quiet requests openai anthropic litellm 2>/dev/null &&
      pip install --quiet pydiode 2>/dev/null || echo 'Warning: pydiode installation failed, skipping' &&
      if [ -f /home/jovyan/requirements.txt ]; then
        pip install --quiet -r /home/jovyan/requirements.txt 2>/dev/null || true;
      fi &&
      chown -R jovyan:users /home/jovyan/work &&
      exec su jovyan -c 'start-notebook.sh'
      "
    env_file: .env
    depends_on:
      - litellm
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8888/api || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # This service provides Jupyter Lab for code execution, data analysis, and AI model interaction.
    # Integrates with OpenRouter via pydiode and can directly access LiteLLM for model inference.
    # Supports HTTPS when enabled via SSL certificates.
    # SECURITY NOTE: By default, authentication is disabled for ease of local development.
    # For production or network-accessible deployments, set JUPYTER_TOKEN in .env to a secure random string.
    # You can also disable GRANT_SUDO and run as non-root user by removing 'user: root'.

  # --- SUPPORT ---
  redis:
    image: redis:alpine
    container_name: magi-nervous-system
    restart: always
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  qdrant:
    image: qdrant/qdrant
    container_name: magi-memory
    restart: always
    ports:
      - "${PORT_QDRANT:-6333}:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
      # Mount SSL certificates if HTTPS is enabled
      - ./config/ssl:/ssl:ro
    environment:
      # HTTPS Configuration
      - ENABLE_HTTPS=${ENABLE_HTTPS:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/ssl/key.pem}
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
