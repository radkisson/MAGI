services:
  # --- THE CORTEX (Brain) ---
  open-webui:
    # Note: Using 'main' tag for latest features as specified in deployment architecture
    image: ghcr.io/open-webui/open-webui:main
    container_name: rin-cortex
    restart: always
    ports:
      - "${PORT_WEBUI:-3000}:8080"
    volumes:
      - ./data/open-webui:/app/backend/data
      # Mount the tools directly so they are available immediately
      - ./tools:/app/backend/data/tools
    environment:
      - OPENAI_API_BASE_URL=http://litellm:4000
      - ENABLE_RAG_WEB_SEARCH=True
      - SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>
    env_file: .env
    depends_on:
      - litellm
      - qdrant
      - searxng
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # --- THE ROUTER ---
  litellm:
    # Note: Using 'main-latest' tag for latest features as specified in deployment architecture
    image: ghcr.io/berriai/litellm:main-latest
    container_name: rin-router
    restart: always
    ports:
      - "${PORT_LITELLM:-4000}:4000"
    volumes:
      - ./config/litellm/config.yaml:/app/config.yaml
      - ./data/litellm:/app/data
    command: [ "--config", "/app/config.yaml", "--port", "4000" ]
    env_file: .env
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DATABASE_URL=  # Disable Prisma/PostgreSQL, use SQLite from config instead

  # --- THE SENSORIUM (Vision) ---
  searxng:
    image: searxng/searxng:latest
    container_name: rin-vision
    restart: always
    ports:
      - "${PORT_SEARXNG:-8080}:8080"
    volumes:
      - ./config/searxng:/etc/searxng
    env_file: .env
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # --- THE DIGESTION ---
  firecrawl:
    image: mendableai/firecrawl:latest
    container_name: rin-digestion
    restart: always
    ports:
      - "${PORT_FIRECRAWL:-3002}:3002"
    environment:
      - REDIS_URL=redis://redis:6379
      - PLAYWRIGHT_MICROSERVICE_URL=http://playwright:3000
      # Automatically uses the key generated in start.sh
      - TEST_API_KEY=${FIRECRAWL_API_KEY} 
    depends_on:
      - redis
      - playwright

  playwright:
    image: mcr.microsoft.com/playwright:v1.43.0-jammy
    container_name: rin-browser
    command: npx -y playwright run-server --port 3000
    restart: always

  # --- THE REFLEX (Autonomy) ---
  n8n:
    image: n8nio/n8n:latest
    container_name: rin-reflex-automation
    restart: always
    ports:
      - "${PORT_N8N:-5678}:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workflows:/workflows:ro
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678
      - GENERIC_TIMEZONE=UTC
      - N8N_EDITOR_BASE_URL=http://localhost:5678
    env_file: .env

  # --- SUPPORT ---
  redis:
    image: redis:alpine
    container_name: rin-nervous-system
    restart: always
    volumes:
      - ./data/redis:/data

  qdrant:
    image: qdrant/qdrant
    container_name: rin-memory
    restart: always
    ports:
      - "${PORT_QDRANT:-6333}:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage
