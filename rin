#!/bin/bash
set -e

# Rhyzomic Intelligence Node (RIN) - CLI Management Tool
# Version: 1.2.0
# Description: Comprehensive CLI for managing RIN lifecycle

# --- Color Definitions ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- Base Directory ---
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# --- Helper Functions ---

print_header() {
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}üß† RIN - $1${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

print_success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚Ñπ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

print_error() {
    echo -e "${RED}‚úó $1${NC}"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker not found. Please install Docker first."
        echo "Run: curl -fsSL https://get.docker.com | sh"
        exit 1
    fi
    
    if ! docker info >/dev/null 2>&1; then
        print_error "Docker is not running. Please start Docker and try again."
        exit 1
    fi
}

load_env() {
    if [ -f "$BASE_DIR/.env" ]; then
        export $(grep -v '^#' "$BASE_DIR/.env" | grep 'PORT_' | xargs)
    fi
}

# --- Command Implementations ---

cmd_start() {
    print_header "Starting RIN"
    
    # Execute the original start.sh script
    if [ -f "$BASE_DIR/start.sh" ]; then
        "$BASE_DIR/start.sh"
    else
        print_error "start.sh not found in $BASE_DIR"
        exit 1
    fi
}

cmd_stop() {
    print_header "Stopping RIN"
    check_docker
    
    cd "$BASE_DIR"
    
    if ! docker compose ps --quiet | grep -q .; then
        print_warning "RIN is not running"
        exit 0
    fi
    
    print_info "Shutting down all subsystems..."
    docker compose down
    
    print_success "RIN stopped successfully"
}

cmd_restart() {
    print_header "Restarting RIN"
    
    cmd_stop
    echo ""
    cmd_start
}

cmd_status() {
    print_header "RIN System Status"
    check_docker
    load_env
    
    cd "$BASE_DIR"
    
    if ! docker compose ps --quiet | grep -q .; then
        print_warning "RIN is not running"
        echo ""
        echo "Start RIN with: ./rin start"
        exit 0
    fi
    
    echo ""
    echo "Container Status:"
    docker compose ps
    
    echo ""
    echo "Service Health:"
    
    # Define services with their health endpoints
    declare -A services=(
        ["Open WebUI (Cortex)"]="http://localhost:${PORT_WEBUI:-3000}"
        ["LiteLLM (Router)"]="http://localhost:${PORT_LITELLM:-4000}/health"
        ["SearXNG (Vision)"]="http://localhost:${PORT_SEARXNG:-8080}"
        ["FireCrawl (Digestion)"]="http://localhost:${PORT_FIRECRAWL:-3002}"
        ["n8n (Reflex)"]="http://localhost:${PORT_N8N:-5678}"
        ["Qdrant (Memory)"]="http://localhost:${PORT_QDRANT:-6333}"
    )
    
    for service in "${!services[@]}"; do
        url="${services[$service]}"
        if curl -s -f -o /dev/null -m 2 "$url" 2>/dev/null; then
            print_success "$service: $url"
        else
            print_error "$service: $url (not responding)"
        fi
    done
    
    echo ""
    echo "Quick Access:"
    echo "  üß† Cortex:     http://localhost:${PORT_WEBUI:-3000}"
    echo "  üîÑ Reflex:     http://localhost:${PORT_N8N:-5678}"
    echo "  üîç Vision:     http://localhost:${PORT_SEARXNG:-8080}"
}

cmd_logs() {
    print_header "RIN Logs"
    check_docker
    
    cd "$BASE_DIR"
    
    local service="$1"
    local follow="${2:-false}"
    
    if [ -z "$service" ]; then
        # Show all logs
        if [ "$follow" = "true" ] || [ "$follow" = "-f" ]; then
            docker compose logs -f
        else
            docker compose logs --tail=50
        fi
    else
        # Show specific service logs
        if [ "$follow" = "true" ] || [ "$follow" = "-f" ]; then
            docker compose logs -f "$service"
        else
            docker compose logs --tail=50 "$service"
        fi
    fi
}

cmd_update() {
    print_header "Updating RIN"
    check_docker
    
    cd "$BASE_DIR"
    
    print_info "Pulling latest Docker images..."
    docker compose pull
    
    print_success "Images updated successfully"
    print_info "Run './rin restart' to apply updates"
}

cmd_upgrade() {
    print_header "Upgrading RIN"
    check_docker
    
    cd "$BASE_DIR"
    
    # Check if we're in a git repository
    if [ ! -d .git ]; then
        print_error "Not a git repository. Cannot upgrade."
        print_info "To upgrade manually:"
        print_info "  1. Backup your data: ./rin backup"
        print_info "  2. Download the latest release"
        print_info "  3. Restore your data: ./rin restore"
        exit 1
    fi
    
    # Save current branch
    current_branch=$(git branch --show-current)
    
    print_info "Fetching latest changes from repository..."
    git fetch origin
    
    print_info "Current branch: $current_branch"
    
    # Check for updates
    if git diff --quiet HEAD origin/$current_branch; then
        print_success "Already up to date"
        exit 0
    fi
    
    print_warning "Updates available. This will pull the latest code."
    read -p "Continue? (y/n) " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Upgrade cancelled"
        exit 0
    fi
    
    # Stop services before upgrading
    print_info "Stopping services..."
    docker compose down
    
    # Pull latest code
    print_info "Pulling latest code..."
    git pull origin "$current_branch"
    
    # Update Docker images
    print_info "Updating Docker images..."
    docker compose pull
    
    print_success "Upgrade completed successfully"
    print_info "Start RIN with: ./rin start"
}

cmd_backup() {
    print_header "Backing Up RIN Data"
    
    local backup_dir="${1:-$BASE_DIR/backups/$(date +%Y%m%d_%H%M%S)}"
    
    print_info "Creating backup in: $backup_dir"
    
    mkdir -p "$backup_dir"
    
    # Backup data directories
    if [ -d "$BASE_DIR/data" ]; then
        print_info "Backing up data directory..."
        cp -r "$BASE_DIR/data" "$backup_dir/"
    fi
    
    # Backup .env file
    if [ -f "$BASE_DIR/.env" ]; then
        print_info "Backing up .env file..."
        cp "$BASE_DIR/.env" "$backup_dir/"
    fi
    
    # Backup config directory
    if [ -d "$BASE_DIR/config" ]; then
        print_info "Backing up config directory..."
        cp -r "$BASE_DIR/config" "$backup_dir/"
    fi
    
    # Backup workflows
    if [ -d "$BASE_DIR/workflows" ]; then
        print_info "Backing up workflows..."
        cp -r "$BASE_DIR/workflows" "$backup_dir/"
    fi
    
    # Create backup manifest
    cat <<EOF > "$backup_dir/backup_manifest.txt"
RIN Backup Manifest
Created: $(date)
Version: 1.2.0

Contents:
- data/          (All service data)
- .env           (Environment configuration)
- config/        (Service configurations)
- workflows/     (n8n workflows)
EOF
    
    print_success "Backup completed: $backup_dir"
}

cmd_restore() {
    print_header "Restoring RIN Data"
    
    local backup_dir="$1"
    
    if [ -z "$backup_dir" ]; then
        print_error "Please specify backup directory"
        echo "Usage: ./rin restore <backup_directory>"
        exit 1
    fi
    
    if [ ! -d "$backup_dir" ]; then
        print_error "Backup directory not found: $backup_dir"
        exit 1
    fi
    
    print_warning "This will overwrite current data with backup."
    read -p "Continue? (y/n) " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Restore cancelled"
        exit 0
    fi
    
    # Stop services before restoring
    print_info "Stopping services..."
    docker compose down 2>/dev/null || true
    
    # Restore data
    if [ -d "$backup_dir/data" ]; then
        print_info "Restoring data directory..."
        rm -rf "$BASE_DIR/data"
        cp -r "$backup_dir/data" "$BASE_DIR/"
    fi
    
    # Restore .env
    if [ -f "$backup_dir/.env" ]; then
        print_info "Restoring .env file..."
        cp "$backup_dir/.env" "$BASE_DIR/"
    fi
    
    # Restore config
    if [ -d "$backup_dir/config" ]; then
        print_info "Restoring config directory..."
        rm -rf "$BASE_DIR/config"
        cp -r "$backup_dir/config" "$BASE_DIR/"
    fi
    
    # Restore workflows
    if [ -d "$backup_dir/workflows" ]; then
        print_info "Restoring workflows..."
        rm -rf "$BASE_DIR/workflows"
        cp -r "$backup_dir/workflows" "$BASE_DIR/"
    fi
    
    print_success "Restore completed successfully"
    print_info "Start RIN with: ./rin start"
}

cmd_ps() {
    print_header "RIN Containers"
    check_docker
    
    cd "$BASE_DIR"
    docker compose ps
}

cmd_exec() {
    check_docker
    
    local service="$1"
    shift
    
    if [ -z "$service" ]; then
        print_error "Please specify a service"
        echo "Usage: ./rin exec <service> <command>"
        echo ""
        echo "Available services:"
        echo "  open-webui    - Open WebUI (Cortex)"
        echo "  litellm       - LiteLLM (Router)"
        echo "  searxng       - SearXNG (Vision)"
        echo "  firecrawl     - FireCrawl (Digestion)"
        echo "  n8n           - n8n (Reflex)"
        echo "  qdrant        - Qdrant (Memory)"
        echo "  redis         - Redis (Nervous System)"
        exit 1
    fi
    
    cd "$BASE_DIR"
    
    if [ $# -eq 0 ]; then
        # No command provided, start interactive shell
        docker compose exec "$service" /bin/sh
    else
        # Execute provided command
        docker compose exec "$service" "$@"
    fi
}

cmd_clean() {
    print_header "Cleaning RIN"
    
    print_warning "This will remove all containers, volumes, and images."
    print_warning "Your data in the data/ directory will be preserved."
    read -p "Continue? (y/n) " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Clean cancelled"
        exit 0
    fi
    
    check_docker
    cd "$BASE_DIR"
    
    print_info "Stopping and removing containers..."
    docker compose down -v
    
    print_info "Removing Docker images..."
    docker compose down --rmi all 2>/dev/null || true
    
    print_success "Cleanup completed"
}

cmd_version() {
    print_header "RIN Version"
    
    echo "RIN Version: 1.2.0"
    echo "CLI Tool: v1.0.0"
    echo ""
    
    if [ -d .git ]; then
        echo "Git Branch: $(git branch --show-current 2>/dev/null || echo 'unknown')"
        echo "Git Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
    fi
}

cmd_help() {
    cat <<EOF
Rhyzomic Intelligence Node (RIN) - CLI Management Tool

USAGE:
    ./rin <command> [options]

COMMANDS:
    start               Start all RIN services
    stop                Stop all RIN services
    restart             Restart all RIN services
    status              Show status of all services
    logs [service] [-f] View logs (optionally follow with -f)
    update              Pull latest Docker images
    upgrade             Upgrade RIN to latest version
    backup [dir]        Backup RIN data
    restore <dir>       Restore RIN data from backup
    ps                  List all running containers
    exec <service> [cmd] Execute command in service container
    clean               Remove all containers and images
    version             Show version information
    help                Show this help message

EXAMPLES:
    ./rin start                     # Start RIN
    ./rin stop                      # Stop RIN
    ./rin status                    # Check system status
    ./rin logs                      # View all logs
    ./rin logs open-webui -f        # Follow Open WebUI logs
    ./rin update                    # Update Docker images
    ./rin backup                    # Create backup
    ./rin restore backups/20231221  # Restore from backup
    ./rin exec redis redis-cli      # Run redis-cli in container

SERVICES:
    open-webui      - Open WebUI (Cortex)
    litellm         - LiteLLM (Router)
    searxng         - SearXNG (Vision)
    firecrawl       - FireCrawl (Digestion)
    n8n             - n8n (Reflex)
    qdrant          - Qdrant (Memory)
    redis           - Redis (Nervous System)
    playwright      - Playwright (Browser)

For more information, visit:
    https://github.com/radkisson/Rhyzomic-Intelligence-Node-RIN-
EOF
}

# --- Main Command Router ---

main() {
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        backup)
            cmd_backup "$@"
            ;;
        restore)
            cmd_restore "$@"
            ;;
        ps)
            cmd_ps "$@"
            ;;
        exec)
            cmd_exec "$@"
            ;;
        clean)
            cmd_clean "$@"
            ;;
        version)
            cmd_version "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

# Execute main function
main "$@"
